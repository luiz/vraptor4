<!DOCTYPE HTML> <html lang="pt"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Environment</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <div class="header-links"> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://www.guj.com.br/tag/vraptor" target="_blank">GUJ Respostas</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en not-selected" title="en" href="../../../en"> EN </a> </li> <li> <a class="site-language flag flag-pt " title="pt" href="../.."> PT </a> </li> </ul> <a href="../../busca/" class="site-search-link">Ir para a página de busca</a> <form action="/pt/busca/" method="get" class="site-search-form"> <input type="search" name="q"> <button type="submit">Buscar</button> </form> </div> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../guia-de-1-minuto/">Documentação</a></li> <li><a href="../../cookbook/aceitando-urls-com-ou-sem-barra-no-final">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentação</h1> <ul> <li><a href="../guia-de-1-minuto">Guia inicial de 1 minuto</a></li> <li><a href="../guia-de-10-minutos">Guia inicial de 10 minutos</a></li> <li><a href="../controllers-rest">Controllers Rest</a></li> <li><a href="../componentes">Componentes</a></li> <li><a href="../conversores">Conversores</a></li> <li><a href="../validacao">Validação</a></li> <li><a href="../interceptadores">Interceptadores</a></li> <li><a href="../eventos">Eventos</a></li> <li><a href="../trabalhando-com-a-view">Trabalhando com a View</a></li> <li><a href="../download-e-upload">Download e Upload</a></li> <li><a href=".">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencias-e-pre-requisitos">Dependências e pré requisitos</a></li> <li><a href="../testando-componentes-e-controllers">Testando Componentes e Controllers</a></li> <li><a href="../migrando-de-um-projeto-com-vraptor3">Migrando de um projeto com VRaptor 3</a></li> <li><a href="../contribuindo-com-o-vraptor">Contribuindo com o VRaptor</a></li> <li><a href="../artigos-e-apresentacoes">Artigos e Apresentações</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="trabalhando-com-diferentes-ambientes">Trabalhando com diferentes ambientes</h1> <p>Environment é uma funcionalidade do VRaptor que nos permite definir componentes e configurações diferentes conforme o ambiente que você está: produção, testes, desenvolvimento, etc.</p> <p>Você pode, por exemplo, desativar o envio de e-mails no ambiente de desenvolvimento, porém habilitar quando estiver em produção.</p> <h2 id="configurao">Configuração</h2> <p>Há várias formas de configurar o environment. A primeira opção é adicionando as linhas abaixo no seu <code>web.xml</code> para, por exemplo, configurar o nome do environment para PRODUCTION:</p> <pre><code class="language-xml"><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>br.com.caelum.vraptor.environment<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>PRODUCTION<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span></code></pre> <p>A segunda opção é configurar uma propriedade na JVM. Para isso, basta iniciar a instância do seu Servlet Container ou Application Server com o seguinte parâmetro:</p> <pre><code class="language-properties"><span class="na">-Dbr.com.caelum.vraptor.environment</span><span class="o">=</span><span class="s">PRODUCTION</span></code></pre> <p>A terceira opção permite configurarmos o nome do environment usando as variáveis de ambiente do sistema operacional, bastando adicionar a variável <code>VRAPTOR_ENV</code>.</p> <p>Exemplo no windows:</p> <pre><code>set VRAPTOR_ENV=PRODUCTION
</code></pre> <p>Exemplo no unix:</p> <pre><code>export VRAPTOR_ENV=PRODUCTION
</code></pre> <p><strong>Nota:</strong> A configuração usando variáveis do sistema operacional possui maior prioridade sobre a configuração de propriedades da JVM, que possui maior prioridade sobre a configuração no <code>web.xml</code>.</p> <h2 id="definindo-as-propriedades-de-um-ambiente">Definindo as propriedades de um ambiente</h2> <p>Basta criar um arquivo de propriedades no classpath da aplicação com o nome do seu ambiente. Por exemplo, para definir as propriedades de produção, devemos criar um arquivo <code>production.properties</code>:</p> <pre><code class="language-properties"><span class="na">ambiente_de_teste</span><span class="o">=</span><span class="s">false</span>
<span class="na">email</span><span class="o">=</span><span class="s">production.mail@mail.com</span></code></pre> <p>Se você tem propriedades que são comuns a outros ambientes, você pode criar um arquivo chamado <code>environment.properties</code> com as propriedades comuns. Quando você precisar usar alguma propriedade, o <code>Environment</code> irá procurar primeiro no arquivo do ambiente, e caso não encontrar, irá procurar o <code>environment.properties</code>.</p> <p>Você também pode sobrescrever propriedades usando System Properties. Propriedades definidas nas System Properties irão sobreescrever quaisquer outras definições. <strong>Nota</strong>: Você só pode usar System Properties para sobreescrever propriedades existentes nos arquivos de propriedades e não para definir novas propriedades.</p> <p>Considerando que você tenha um environment.properties abaixo: ~~~ #!properties my.prop hello ~~~ </p> <p>Você pode sobrescrever a propriedade existente my.prop com uma System Property: ~~~ #!java System.setProperty(“my.prop”, “bye”); environment.get(“my.prop”); //bye ~~~ </p> <p>Se a chave não existir no arquivo de propriedades, o método get irá lançar uma NoSuchElementException.</p> <h2 id="acessando-propriedades-de-ambiente-no-seu-cdigo">Acessando propriedades de ambiente no seu código</h2> <p>Há dois métodos para acessar as propriedades de ambiente via código: <code>get</code> e <code>getOrDefault</code>. O método <code>get</code> retorna o valor da propriedade ou uma <code>MissingResourceException</code> se a propriedade não for encontrada. Já o método <code>getOrDefault</code> retorna o valor da propriedade, ou um valor padrão caso não encontrada.</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MeuController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Environment</span> <span class="n">environment</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">MailSender</span> <span class="n">sender</span><span class="o">;</span>

    <span class="cm">/**</span>
<span class="cm">     * @deprecated CDI eyes only</span>
<span class="cm">     */</span>
    <span class="kd">protected</span> <span class="nf">MeuController</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">MeuController</span><span class="o">(</span><span class="n">Environment</span> <span class="n">environment</span><span class="o">,</span> <span class="n">MailSender</span> <span class="n">sender</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sender</span> <span class="o">=</span> <span class="n">sender</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">isDevelopment</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>No código acima, <code>environment.get("email")</code> irá retornar o valor da propriedade <code>email</code>. Porém caso a propriedade não existir em todos os ambientes, você pode usar o método <code>getOrDefault</code> para retornar um valor padrão.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">isDevelopment</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="s">"email"</span><span class="o">),</span> <span class="s">"noreply@vraptor.org"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="acessando-propriedades-de-ambiente-no-jsp">Acessando propriedades de ambiente no JSP</h2> <pre><code class="language-xml"><span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">"${environment.isTest()}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>Você está no ambiente de teste. Suas ações aqui não afetarão o sistema.<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>

Enviando e-mail para: ${environment.get('email')}</code></pre> <h2 id="acessando-arquivos-de-configurao-de-acordo-com-o-environment">Acessando arquivos de configuração de acordo com o environment</h2> <p>Se você precisa acessar um arquivo de configuração diferente para suas bibliotecas, de acordo com seu ambiente, você também pode utilizar o Environemnt. Basta colocar, por exemplo, seu <code>hibernate.cfg.xml</code> em diretórios com o nome de seus ambientes: <em>development</em> e <em>production</em> (por exemplo). <code>Environment.getResource(...)</code> retornará o resource de acordo com seu ambiente atual:</p> <pre><code class="language-java"><span class="n">cfg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnotationConfiguration</span><span class="o">();</span>
<span class="n">cfg</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">"/hibernate.cfg.xml"</span><span class="o">));</span></code></pre> <p>Para manter compatibilidade com quem não utilizava o environment, caso o arquivo não seja encontrado no diretório com o nome do ambiente, ele será carregado no diretório root (do classpath).</p> <h2 id="injetando-o-valor-de-suas-configurao-programaticamente">Injetando o valor de suas configuração programaticamente</h2> <p>Você também consegue injetar suas configurações programaticamente usando o <code>@Property</code>, por exemplo:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MeuController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Property</span><span class="o">(</span><span class="s">"email"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Neste caso, se o seu environment estiver com valor <code>DEVELOPMENT</code>, vai injetar o valor que corresponde a chave <em>email</em> do arquivo <code>development.properties</code>, se estiver com <code>PRODUCTION</code> do <code>production.properties</code> e assim por diante. Dessa forma você não precisa dos ifs como: <code>if(environment.isDevelopment()) {...}</code> em seu código.</p> <p>Outra facilidade, é que se o nome da chave for o mesmo nome do field injetado, como em nosso caso com a chave <em>email</em>, você pode deixar apenas o <code>@Property</code> que o nome será inferido. Seu controller ficaria assim:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MeuController</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Property</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">sender</span><span class="o">.</span><span class="na">sendMailTo</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Você também pode definir um valor padrão para essa propriedade:</p> <pre><code class="language-java"><span class="nd">@Inject</span>
<span class="nd">@Property</span><span class="o">(</span><span class="n">defaultValue</span> <span class="o">=</span> <span class="s">"config.properties"</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">fileName</span><span class="o">;</span></code></pre> </main> <script src="../../../js/search-pt.js"></script> <script src="/js/headers.min.js"></script> </body> </html>