<!DOCTYPE HTML> <html lang="pt"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <title>VRaptor 4 - Download e Upload</title> <link rel="shortcut icon" href="../../../img/favicon.png"> <link rel="stylesheet" href="/css/style.min.css"/> <meta name="generator" content="nanoc 3.6.7"> </head> <body> <header class="container"> <h1 class="logo"><a class="logo-link" href="../.."> <img src="../../../img/logo.png" alt="VRaptor"> </a></h1> <div class="header-links"> <ul class="community"> <li><a href="https://groups.google.com/forum/#!forum/caelum-vraptor" target="_blank">Google Groups</a></li> <li><a href="https://github.com/caelum/vraptor4/" target="_blank">GitHub</a></li> <li><a href="http://www.guj.com.br/tag/vraptor" target="_blank">GUJ Respostas</a></li> </ul> <ul class="site-languages"> <li> <a class="site-language flag flag-en not-selected" title="en" href="../../../en"> EN </a> </li> <li> <a class="site-language flag flag-pt " title="pt" href="../.."> PT </a> </li> </ul> <a href="../../busca/" class="site-search-link">Ir para a página de busca</a> <form action="/pt/busca/" method="get" class="site-search-form"> <input type="search" name="q"> <button type="submit">Buscar</button> </form> </div> </header> <input type="checkbox" id="nav-visibility"> <label for="nav-visibility" class="nav-toggle">Menu</label> <nav class="main-nav"> <ul> <li><a href="../../download">Download</a></li> <li><a href="../guia-de-1-minuto/">Documentação</a></li> <li><a href="../../cookbook/aceitando-urls-com-ou-sem-barra-no-final">Cookbook</a></li> <li><a href="https://github.com/caelum/vraptor4/releases" target="_blank">Changelog</a></li> <li><a href="https://github.com/caelum/vraptor4/milestones" target="_blank">Roadmap</a></li> <li><a href="../../../javadoc">Javadoc</a></li> </ul> </nav> <nav class="doc-nav container"> <h1>Documentação</h1> <ul> <li><a href="../guia-de-1-minuto">Guia inicial de 1 minuto</a></li> <li><a href="../guia-de-10-minutos">Guia inicial de 10 minutos</a></li> <li><a href="../controllers-rest">Controllers Rest</a></li> <li><a href="../componentes">Componentes</a></li> <li><a href="../conversores">Conversores</a></li> <li><a href="../validacao">Validação</a></li> <li><a href="../interceptadores">Interceptadores</a></li> <li><a href="../eventos">Eventos</a></li> <li><a href="../trabalhando-com-a-view">Trabalhando com a View</a></li> <li><a href=".">Download e Upload</a></li> <li><a href="../environment">Environment</a></li> <li><a href="../plugins">Plugins</a></li> <li><a href="../dependencias-e-pre-requisitos">Dependências e pré requisitos</a></li> <li><a href="../testando-componentes-e-controllers">Testando Componentes e Controllers</a></li> <li><a href="../migrando-de-um-projeto-com-vraptor3">Migrando de um projeto com VRaptor 3</a></li> <li><a href="../contribuindo-com-o-vraptor">Contribuindo com o VRaptor</a></li> <li><a href="../artigos-e-apresentacoes">Artigos e Apresentações</a></li> </ul> </nav> <main class="container doc-container"> <h1 id="exemplo-de-1-minuto-download">Exemplo de 1 minuto: download</h1> <p>O exemplo a seguir mostra como disponibilizar o download para seu cliente. Note novamente a simplicidade na implementação:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PerfilController</span> <span class="o">{</span>
    
    <span class="kd">public</span> <span class="n">File</span> <span class="nf">foto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"/path/para/a/foto."</span> <span class="o">+</span> <span class="n">perfil</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span> <span class="s">".jpg"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <h2 id="adicionando-mais-informaes-no-download">Adicionando mais informações no download</h2> <p>Se você quiser adicionar mais informações ao download você pode retornar um <code>FileDownload</code>:</p> <pre><code class="language-java"><span class="nd">@Controller</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PerfilController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Download</span> <span class="nf">foto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/caminho/para/a/foto."</span> <span class="o">+</span> <span class="n">perfil</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span> <span class="s">".jpg"</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="s">"image/jpg"</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">perfil</span><span class="o">.</span><span class="na">getNome</span><span class="o">()</span> <span class="o">+</span> <span class="s">".jpg"</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">FileDownload</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">contentType</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>Para as situações em que você tem um <code>InputStream</code>, você pode utilizar o <code>InputStreamDownload</code>, conforme o exemplo abaixo:</p> <pre><code class="language-java"><span class="kd">public</span> <span class="n">Download</span> <span class="nf">foto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">InputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="o">[...];</span>
    <span class="n">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="s">"image/jpg"</span><span class="o">;</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">InputStreamDownload</span><span class="o">(</span><span class="n">stream</span><span class="o">,</span> <span class="n">contentType</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
<span class="o">}</span></code></pre> <p>E como outra opção há o <code>ByteArrayDownload</code>, usado quando você tem um array de bytes.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="n">Download</span> <span class="nf">foto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">conteudoFoto</span> <span class="o">=</span> <span class="o">[...];</span>
    <span class="n">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="s">"image/jpg"</span><span class="o">;</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">ByteArrayDownload</span><span class="o">(</span><span class="n">conteudoFoto</span><span class="o">,</span> <span class="n">contentType</span><span class="o">,</span> <span class="n">filename</span><span class="o">);</span>
<span class="o">}</span></code></pre> <p>Você também pode enviar uma lista de arquivos para download, e desta forma eles serão enviados ao browser comprimidos em um arquivo Zip.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="n">Download</span> <span class="nf">fotos</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Path</span> <span class="n">foto01</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/caminho/para/a/foto01.jpg"</span><span class="o">).</span><span class="na">toPath</span><span class="o">();</span>
    <span class="n">Path</span> <span class="n">foto02</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/caminho/para/a/foto02.jpg"</span><span class="o">).</span><span class="na">toPath</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ZipDownload</span><span class="o">(</span><span class="s">"fotos.zip"</span><span class="o">,</span> <span class="n">foto01</span><span class="o">,</span> <span class="n">foto02</span><span class="o">);</span>
<span class="o">}</span></code></pre> <h2 id="usando-o-downloadbuilder">Usando o DownloadBuilder</h2> <p><code>DownloadBuilder</code> é uma classe útil para ajudar você a criar instâncias da classe <code>Download</code>, usando uma interface fluente. Para criar uma instância de um <code>FileDownload</code> você pode escrever o seguinte código:</p> <pre><code class="language-java"><span class="n">FileDownload</span> <span class="n">download</span> <span class="o">=</span> <span class="n">DownloadBuilder</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">meuArquivo</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withFileName</span><span class="o">(</span><span class="s">"curriculo.txt"</span><span class="o">)</span> <span class="c1">// opcional, o padrão é File.getName()</span>
    <span class="o">.</span><span class="na">withContentType</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">)</span> <span class="c1">// optional, não será enviado se nulo</span>
    <span class="o">.</span><span class="na">downloadable</span><span class="o">()</span> <span class="c1">// opcional, o padrão é inline content</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span></code></pre> <h1 id="upload">Upload</h1> <p>Para ativar o suporte a upload é necessário adicionar as bibliotecas <code>commons-upload</code> e <code>commons-io</code> em seu classpath. Veja mais informações <a href="../dependencias-e-pre-requisitos/#commons-fileupload">aqui</a>.</p> <p>**Nota: ** O upload funciona apenas com métodos do seu controller anotados com <code>@Post</code>. <code>@Get</code>, <code>@Put</code> e demais verbos não são suportados.</p> <h2 id="exemplo-de-1-minuto-upload">Exemplo de 1 minuto: upload</h2> <p>Para receber um upload você precisa receber um <code>UploadedFile</code> em seu método conforme o exemplo abaixo. O <code>UploadedFile</code> retorna o arquivo como um <code>InputStream</code>. Com isso você pode copiar o arquivo para o disco facilmente.</p> <pre><code class="language-java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">atualizaFoto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">,</span> <span class="n">UploadedFile</span> <span class="n">foto</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">File</span> <span class="n">fotoSalva</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"/path/to/file/repository"</span><span class="o">,</span> <span class="n">foto</span><span class="o">.</span><span class="na">getFileName</span><span class="o">());</span>
    <span class="n">foto</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">fotoSalva</span><span class="o">);</span>
    <span class="n">dao</span><span class="o">.</span><span class="na">atribui</span><span class="o">(</span><span class="n">fotoSalva</span><span class="o">,</span> <span class="n">perfil</span><span class="o">);</span>
<span class="o">}</span></code></pre> <h2 id="sobrescrevendo-as-configuraes-de-upload">Sobrescrevendo as configurações de upload</h2> <p>Há duas formas para alterar as configurações de upload. </p> <p>A primeira forma é estendendo a classe <code>DefaultMultipartConfig</code>. Isto é útil quando você precisa alterar o diretório temporário de arquivos ou o tamanho máximo do upload de forma global.</p> <p>O valor padrão para o upload é de 2MB para cada arquivo, e o mesmo valor para a soma de todos os arquivos. Mas estes valores podem ser facilmente alterados como você pode ver no exemplo abaixo:</p> <pre><code class="language-java"><span class="nd">@Specializes</span>
<span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomMultipartConfig</span> <span class="kd">extends</span> <span class="n">DefaultMultipartConfig</span> <span class="o">{</span>

    <span class="c1">// alteramos o tamanho total do upload para 50MB</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getSizeLimit</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// alteramos o tamanho do upload de cada arquivo para 20MB</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getFileSizeLimit</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre> <p>A segunda forma é usando a anotação <code>UploadSizeLimit</code>, que permite alterar a configuração do upload para um único método. No exemplo abaixo alteramos a configuração para permitir que cada arquivo tenha no máximo 10MB e o upload total tenha no máximo 40MB:</p> <pre><code class="language-java"><span class="nd">@UploadSizeLimit</span><span class="o">(</span><span class="n">sizeLimit</span><span class="o">=</span><span class="mi">40</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">,</span> <span class="n">fileSizeLimit</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">atualizaFoto</span><span class="o">(</span><span class="n">Perfil</span> <span class="n">perfil</span><span class="o">,</span> <span class="n">UploadedFile</span> <span class="n">foto</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">[...]</span>
<span class="o">}</span></code></pre> <p>A configuração pela anotação tem maior prioridade em relação a configuração global. Você pode usar as duas, porém se um método possuir a anotação <code>UploadSizeLimit</code>, estes valores serão usados para validar o tamanho do upload, ignorando a configuração global.</p> <h2 id="alterando-o-formulrio-de-envio">Alterando o formulário de envio</h2> <p>Para que o browser possa fazer o upload corretamente, você precisa adicionar o atributo enctype para <code>multipart/form-data</code>:</p> <pre><code class="language-jsp"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"minha-action"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span></code></pre> <h2 id="validando-o-upload">Validando o upload</h2> <p>Quando o tamanho máximo para upload de arquivo exceder o valor configurado, o VRaptor adiciona uma mensagem no objeto <code>Validator</code>.</p> </main> <script src="../../../js/search-pt.js"></script> <script src="/js/headers.min.js"></script> </body> </html>